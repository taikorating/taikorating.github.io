<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤ªé¼“ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒãƒƒãƒ</title>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;800&display=swap" rel="stylesheet">
    <style>
        /* --- ãƒ‡ã‚¶ã‚¤ãƒ³å®šç¾© --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'M PLUS Rounded 1c', "Hiragino Kaku Gothic ProN", sans-serif;
            background-color: #fce4d6;
            background-image: radial-gradient(#ffccbc 10%, transparent 10%);
            background-size: 20px 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: #333;
            overflow: hidden;
        }
        
        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
        .game-container {
            background: #fff;
            width: 100%;
            max-width: 500px;
            height: 90vh; /* ç”»é¢ã®é«˜ã•ã®90% */
            max-height: 800px;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            text-align: center;
            border: 4px solid #ff5722;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow-y: auto; /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒå¤šã„å ´åˆã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
        }

        /* å…±é€šãƒ‘ãƒ¼ãƒ„ */
        h1, h2, h3 { font-weight: 800; }
        .title-logo { font-size: 2.2rem; color: #ff5722; text-shadow: 2px 2px 0px #ffe0b2; margin-bottom: 5px; }
        .sub-title { color: #f57c00; font-weight: bold; margin-bottom: 20px; font-size: 0.9rem; }
        
        button { font-family: inherit; outline: none; }
        .btn { border: none; padding: 12px; border-radius: 10px; cursor: pointer; transition: 0.1s; width: 100%; font-weight: bold; color: white; margin-bottom: 10px; box-shadow: 0 4px 0 rgba(0,0,0,0.1); position: relative; top: 0;}
        .btn:active { top: 3px; box-shadow: 0 1px 0 rgba(0,0,0,0.1); }
        .btn-orange { background: #ff5722; }
        .btn-blue { background: #2196f3; }
        .btn-green { background: #4caf50; }
        .btn-gray { background: #757575; }
        
        /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ç”¨ */
        .login-btn-group { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .btn-google { background: #db4437; }
        .btn-x { background: #000; }
        .btn-email { background: #607d8b; }
        
        /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ãƒãƒ¼ */
        .profile-bar {
            background: #333; color: white; padding: 10px 15px; border-radius: 12px;
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; box-shadow: 0 4px 0 #000;
        }
        .profile-name { font-size: 0.9rem; text-align: left; }
        .profile-rate { color: #ffd700; font-size: 1.1rem; }
        .settings-icon { cursor: pointer; font-size: 1.2rem; }

        /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ç¾¤ */
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .menu-btn { height: 80px; font-size: 1rem; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        
        /* ãƒ©ãƒ³ã‚­ãƒ³ã‚° */
        .rank-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        .rank-table th { background: #ffccbc; padding: 8px; color: #d84315; }
        .rank-table td { border-bottom: 1px solid #eee; padding: 8px; }
        .rank-1 { color: #d4af37; font-weight: bold; font-size: 1.1rem; } /* é‡‘ */
        .rank-2 { color: #a0a0a0; font-weight: bold; } /* éŠ€ */
        .rank-3 { color: #cd7f32; font-weight: bold; } /* éŠ… */

        /* ç”»é¢åˆ‡ã‚Šæ›¿ãˆ */
        .screen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; }
        .screen.active { display: flex; }
        .center-content { justify-content: center; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-box { background: white; padding: 25px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.3); animation: popIn 0.3s; }
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        .input-field { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 15px; font-size: 1rem; }
        .input-label { display: block; text-align: left; font-weight: bold; margin-bottom: 5px; font-size: 0.8rem; color: #555; }

        /* ãƒ­ãƒ¼ãƒ€ãƒ¼ */
        .loader { border: 6px solid #f3f3f3; border-top: 6px solid #ff5722; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* çµæœç”»é¢ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .rate-diff { font-size: 1.5rem; opacity: 0; transition: 0.5s; display: block; height: 30px; }
        .rate-diff.show { opacity: 1; transform: translateY(-5px); }

    </style>
</head>
<body>

    <div class="game-container">
        
        <div id="login-screen" class="screen active center-content">
            <h1 class="title-logo">DON-DER MATCH</h1>
            <p class="sub-title">ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦å¯¾æˆ¦ã‚’å§‹ã‚ã‚ˆã†</p>
            
            <div class="login-btn-group" style="width: 100%;">
                <button class="btn btn-google" onclick="loginWithGoogle()">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
                <button class="btn btn-x" onclick="alert('Xãƒ­ã‚°ã‚¤ãƒ³ã«ã¯APIè¨­å®šãŒå¿…è¦ã§ã™ã€‚\nç¾åœ¨ã¯ä»–ã®æ–¹æ³•ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚')">X (Twitter) ã§ãƒ­ã‚°ã‚¤ãƒ³</button>
                
                <div style="display:flex; gap:5px;">
                    <input type="email" id="email-input" class="input-field" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" style="margin:0;">
                    <input type="password" id="pass-input" class="input-field" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" style="margin:0;">
                </div>
                <div style="display:flex; gap:5px;">
                    <button class="btn btn-email" onclick="loginWithEmail()">ç™»éŒ²/ãƒ­ã‚°ã‚¤ãƒ³</button>
                </div>

                <button class="btn btn-gray" onclick="loginAnon()">åŒ¿åã§å§‹ã‚ã‚‹</button>
            </div>
        </div>

        <div id="title-screen" class="screen">
            <h1 class="title-logo">DON-DER MATCH</h1>
            
            <div class="profile-bar">
                <div>
                    <div class="profile-name" id="display-name">Loading...</div>
                    <div style="font-size:0.8rem; opacity:0.8;" id="display-xid">@æœªè¨­å®š</div>
                </div>
                <div style="text-align:right;">
                    <div class="profile-rate">Rate: <span id="display-rate">---</span></div>
                    <span class="settings-icon" onclick="openProfileModal()">âš™ï¸è¨­å®š</span>
                </div>
            </div>

            <div class="menu-grid">
                <button class="btn btn-orange menu-btn" onclick="openRanking()">
                    <span>ğŸ†</span>ãƒ©ãƒ³ã‚­ãƒ³ã‚°
                </button>
                <button class="btn btn-blue menu-btn" onclick="alert('å±¥æ­´æ©Ÿèƒ½ã¯ã¾ã å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã›ã‚“')">
                    <span>ğŸ“œ</span>å¯¾æˆ¦å±¥æ­´
                </button>
            </div>

            <p style="font-weight:bold; margin-bottom:10px;">å¯¾æˆ¦é›£æ˜“åº¦ã‚’é¸æŠ</p>
            <button class="btn btn-green" onclick="tryStartMatching('normal')">é›£æ˜“åº¦ F ï½ A+</button>
            <button class="btn btn-orange" onclick="tryStartMatching('hard')">é›£æ˜“åº¦ S ï½ SS</button>
        </div>

        <div id="matching-screen" class="screen center-content">
            <div class="loader"></div>
            <h3>å¯¾æˆ¦ç›¸æ‰‹ã‚’æ¢ã—ã¦ã„ã¾ã™...</h3>
            <p id="match-status" style="color:#ff5722; margin-top:10px;"></p>
            <button class="btn btn-gray" style="margin-top:30px; width:50%;" onclick="cancelMatching()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>

        <div id="reveal-screen" class="screen" style="padding-top:20px;">
            <h2 style="color:#ff5722;">MATCH START!</h2>
            <p>VS å¯¾æˆ¦ç›¸æ‰‹</p>
            <div style="font-size:1.5rem; font-weight:bold; color:#1da1f2; border:2px solid #1da1f2; padding:10px; border-radius:10px; margin:10px 0;">
                <span id="opponent-x-display"></span>
            </div>
            <div id="song-reveal-container" style="width:100%; margin-top:10px; flex:1;"></div>
            <button id="goto-report-btn" class="btn btn-green" style="display:none;" onclick="goToReportScreen()">çµæœã‚’å ±å‘Šã™ã‚‹</button>
        </div>

        <div id="report-screen" class="screen center-content">
            <h2>çµæœå ±å‘Š</h2>
            <div style="background:#f5f5f5; padding:15px; border-radius:10px; width:100%; text-align:left; margin-bottom:20px;">
                <p><strong>ç›¸æ‰‹:</strong> <span id="rep-opp-name"></span></p>
                <p><strong>èª²é¡Œæ›²:</strong> <span id="rep-song-1"></span> ...</p>
            </div>
            <div style="display:flex; gap:10px; width:100%;">
                <button class="btn" style="background:#e91e63;" onclick="confirmResult('WIN')">å‹ã¡</button>
                <button class="btn" style="background:#9c27b0;" onclick="confirmResult('DRAW')">å¼•åˆ†</button>
                <button class="btn" style="background:#2196f3;" onclick="confirmResult('LOSE')">è² ã‘</button>
            </div>
        </div>

        <div id="waiting-result-screen" class="screen center-content">
            <div class="loader"></div>
            <h3>ç¢ºèªä¸­...</h3>
            <p>ç›¸æ‰‹ã®å…¥åŠ›ã‚’å¾…ã£ã¦ã„ã¾ã™</p>
        </div>

        <div id="final-result-screen" class="screen center-content">
            <h1 id="final-title" style="font-size:3rem; margin-bottom:10px;">WIN!</h1>
            <div style="margin:20px 0;">
                <div style="font-size:3rem; font-weight:900;" id="anim-rate-val">1500</div>
                <div class="rate-diff" id="anim-rate-diff">+20</div>
            </div>
            <button class="btn btn-gray" onclick="returnToTitle()">ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹</button>
        </div>
    </div>

    <div id="profile-modal" class="modal-overlay">
        <div class="modal-box">
            <h3>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š</h3>
            <div style="margin-top:20px;">
                <label class="input-label">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å (ã‚¢ãƒ—ãƒªå†…è¡¨ç¤º)</label>
                <input type="text" id="edit-name" class="input-field" placeholder="ä¾‹: ã©ã‚“ã¡ã‚ƒã‚“">
                
                <label class="input-label">X(Twitter) ID</label>
                <p style="font-size:0.7rem; color:#e91e63; text-align:left;">â€»å¯¾æˆ¦ã«ã¯å…ˆé ­ã« @ ãŒå¿…è¦ã§ã™</p>
                <input type="text" id="edit-xid" class="input-field" placeholder="ä¾‹: @taiko_master">
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-gray" onclick="closeModal('profile-modal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-orange" onclick="saveProfile()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div id="ranking-modal" class="modal-overlay">
        <div class="modal-box" style="max-width:450px;">
            <h3>ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
            <p style="font-size:0.8rem; margin-bottom:10px;">Top 10 Players</p>
            <div style="max-height:300px; overflow-y:auto;">
                <table class="rank-table">
                    <thead><tr><th>é †ä½</th><th>åå‰</th><th>ãƒ¬ãƒ¼ãƒˆ</th></tr></thead>
                    <tbody id="ranking-list"></tbody>
                </table>
            </div>
            <button class="btn btn-gray" style="margin-top:20px;" onclick="closeModal('ranking-modal')">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-box">
            <h3>ç¢ºèª</h3>
            <p style="margin:15px 0;">çµæœã¯ã€Œ<span id="modal-selection" style="font-weight:bold; color:#ff5722;"></span>ã€ã§<br>é–“é•ã„ãªã„ã§ã™ã‹ï¼Ÿ</p>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-gray" onclick="closeModal('confirm-modal')">æˆ»ã‚‹</button>
                <button class="btn btn-orange" onclick="submitResult()">æ±ºå®š</button>
            </div>
        </div>
    </div>

    <div id="error-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="color:#d32f2f;">çµæœä¸ä¸€è‡´</h3>
            <p>ãŠäº’ã„ã®ç”³å‘ŠãŒé£Ÿã„é•ã£ã¦ã„ã¾ã™ã€‚<br>ã‚‚ã†ä¸€åº¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
            <button class="btn btn-orange" onclick="retryReport()">å†å…¥åŠ›</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, onSnapshot, deleteDoc, doc, updateDoc, limit, getDoc, setDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // â˜…â˜…â˜… APIã‚­ãƒ¼ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ â˜…â˜…â˜…
        const firebaseConfig = {
  apiKey: "AIzaSyBU1LAF6ceIsezKarsiecSTbH87Cb3gnTw",
  authDomain: "taikorating.firebaseapp.com",
  projectId: "taikorating",
  storageBucket: "taikorating.firebasestorage.app",
  messagingSenderId: "657970223088",
  appId: "1:657970223088:web:509230d6b20d78cbf3af35",
  measurementId: "G-PJXEXL5E9M"
};


        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // å¤‰æ•°
        let currentUser = null;
        let userData = { displayName: "åç„¡ã—", xId: "æœªè¨­å®š", rate: 1500 }; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
        let waitingDocId = null;
        let currentRoomId = null;
        let unsubscribeRoom = null;
        let currentMatchData = {};
        let selectedResult = null;

        const songDatabase = {
            'normal': ["å¤ç¥­ã‚Š", "ç´…", "ã•ãã‚‰ã‚“ã¼", "å‰å‰å‰ä¸–", "å¤©ä½“è¦³æ¸¬", "åƒæœ¬æ¡œ", "å¥³ã€…ã—ãã¦", "ã‚·ãƒ£ãƒ«ãƒ«"],
            'hard': ["å¹½ç„ãƒä¹±", "ãƒ‰ãƒ³ã‚«ãƒ2000", "ç¬¬å…­å¤©é­”ç‹", "ã‚«ã‚ªã‚¹ã‚¿ã‚¤ãƒ ", "Infinite Rebellion", "åŒç«œãƒä¹±", "poxeiâ™¦DOON"]
        };

        // --- èªè¨¼ç³» ---
        window.loginAnon = () => signInAnonymously(auth).catch(e => alert(e.message));
        window.loginWithGoogle = () => signInWithPopup(auth, new GoogleAuthProvider()).catch(e => alert(e.message));
        window.loginWithEmail = async () => {
            const email = document.getElementById('email-input').value;
            const pass = document.getElementById('pass-input').value;
            if(!email || !pass) return alert("ãƒ¡ãƒ¼ãƒ«ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch(e) {
                // ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—ãªã‚‰ä½œæˆã‚’è©¦ã¿ã‚‹ï¼ˆç°¡æ˜“å®Ÿè£…ï¼‰
                try {
                    await createUserWithEmailAndPassword(auth, email, pass);
                } catch(e2) {
                    alert("ãƒ­ã‚°ã‚¤ãƒ³/ç™»éŒ²ã‚¨ãƒ©ãƒ¼: " + e2.message);
                }
            }
        };

        // ãƒ­ã‚°ã‚¤ãƒ³ç›£è¦– & ãƒ‡ãƒ¼ã‚¿åŒæœŸ
        onAuthStateChanged(auth, async (user) => {
            if(user) {
                currentUser = user;
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ãƒ»ä½œæˆ (usersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³)
                const userRef = doc(db, "users", user.uid);
                const userSnap = await getDoc(userRef);

                if (userSnap.exists()) {
                    userData = userSnap.data();
                } else {
                    // æ–°è¦ä½œæˆ
                    userData = { displayName: "åç„¡ã—ã©ã‚“", xId: "æœªè¨­å®š", rate: 1500, createdAt: new Date() };
                    await setDoc(userRef, userData);
                }
                updateProfileUI();
                switchScreen('title-screen'); // ã‚¿ã‚¤ãƒˆãƒ«ã¸ç§»å‹•

                // ã‚»ãƒƒã‚·ãƒ§ãƒ³å¾©å¸°ãƒã‚§ãƒƒã‚¯
                const savedRoomId = localStorage.getItem('current_room_id');
                if (savedRoomId && userSnap.exists()) { // ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰å®Œäº†å¾Œã«å¾©å¸°
                    checkRestore(savedRoomId);
                }
            }
        });

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’UIã«åæ˜ 
        const updateProfileUI = () => {
            document.getElementById('display-name').innerText = userData.displayName;
            document.getElementById('display-xid').innerText = userData.xId;
            document.getElementById('display-rate').innerText = userData.rate;
            
            // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã«ã‚‚ã‚»ãƒƒãƒˆ
            document.getElementById('edit-name').value = userData.displayName;
            document.getElementById('edit-xid').value = userData.xId;
        };

        // --- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š ---
        window.openProfileModal = () => document.getElementById('profile-modal').style.display = 'flex';
        
        window.saveProfile = async () => {
            const newName = document.getElementById('edit-name').value;
            const newXid = document.getElementById('edit-xid').value;
            
            if(!newName) return alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

            // Firestoreæ›´æ–°
            await updateDoc(doc(db, "users", currentUser.uid), {
                displayName: newName,
                xId: newXid || "æœªè¨­å®š"
            });
            
            userData.displayName = newName;
            userData.xId = newXid || "æœªè¨­å®š";
            updateProfileUI();
            closeModal('profile-modal');
        };

        // --- ãƒ©ãƒ³ã‚­ãƒ³ã‚° ---
        window.openRanking = async () => {
            document.getElementById('ranking-modal').style.display = 'flex';
            const tbody = document.getElementById('ranking-list');
            tbody.innerHTML = '<tr><td colspan="3">èª­ã¿è¾¼ã¿ä¸­...</td></tr>';

            const q = query(collection(db, "users"), orderBy("rate", "desc"), limit(10));
            const snapshot = await getDocs(q);
            
            tbody.innerHTML = "";
            let rank = 1;
            snapshot.forEach(doc => {
                const d = doc.data();
                const tr = document.createElement('tr');
                let rankClass = "";
                if(rank===1) rankClass="rank-1";
                if(rank===2) rankClass="rank-2";
                if(rank===3) rankClass="rank-3";
                
                tr.innerHTML = `
                    <td class="${rankClass}">${rank}</td>
                    <td style="text-align:left;">${d.displayName}</td>
                    <td>${d.rate}</td>
                `;
                tbody.appendChild(tr);
                rank++;
            });
        };

        // --- ãƒãƒƒãƒãƒ³ã‚°é–‹å§‹ (ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ã) ---
        window.tryStartMatching = (mode) => {
            // æ¡ä»¶ãƒã‚§ãƒƒã‚¯
            if (userData.xId === "æœªè¨­å®š" || !userData.xId.startsWith("@")) {
                alert("ã€å¯¾æˆ¦ã‚¨ãƒ©ãƒ¼ã€‘\nX IDãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nè¨­å®šãƒœã‚¿ãƒ³ã‹ã‚‰ã€Œ@ã€ã§å§‹ã¾ã‚‹IDã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚\n(ä¾‹: @taiko_master)");
                openProfileModal();
                return;
            }
            startMatching(mode);
        };

        // --- ä»¥ä¸‹ã€å‰å›ã¾ã§ã®ãƒãƒƒãƒãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯ (å°‘ã—ä¿®æ­£) ---
        const switchScreen = (id) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        };
        window.closeModal = (id) => document.getElementById(id).style.display = 'none';

        const checkRestore = async (roomId) => {
             const roomSnap = await getDoc(doc(db, "rooms", roomId));
             if(roomSnap.exists()) watchRoom(roomId);
             else localStorage.removeItem('current_room_id');
        };

        const pickRandomSongs = (mode) => {
            const list = songDatabase[mode] || [];
            return [...list].sort(() => 0.5 - Math.random()).slice(0, 3);
        };

        const startMatching = async (mode) => {
            switchScreen('matching-screen');
            document.getElementById('match-status').innerText = "å¯¾æˆ¦ç›¸æ‰‹ã‚’æ¢ã—ã¦ã„ã¾ã™...";

            try {
                // è‡ªåˆ†ä»¥å¤–ã®å¾…æ©Ÿè€…ã‚’æ¢ã™
                const q = query(collection(db, "waiting_room"), where("mode", "==", mode), limit(10));
                const snap = await getDocs(q);
                let opponentDoc = null;
                snap.forEach(d => { if(d.data().uid !== currentUser.uid) opponentDoc = d; });

                if(opponentDoc) {
                    // ãƒãƒƒãƒæˆç«‹
                    const opp = opponentDoc.data();
                    await deleteDoc(doc(db, "waiting_room", opponentDoc.id));
                    
                    const roomRef = await addDoc(collection(db, "rooms"), {
                        mode: mode, songs: pickRandomSongs(mode), createdAt: new Date(),
                        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã¯DBä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ã“ã“ã«ã¯å¿…è¦æœ€å°é™ã‹ã€ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’å…¥ã‚Œã‚‹
                        player1: { uid: opp.uid, xId: opp.xId, displayName: opp.displayName, result: null },
                        player2: { uid: currentUser.uid, xId: userData.xId, displayName: userData.displayName, result: null }
                    });
                    
                    localStorage.setItem('current_room_id', roomRef.id);
                    watchRoom(roomRef.id);
                } else {
                    // å¾…æ©Ÿ
                    const ref = await addDoc(collection(db, "waiting_room"), {
                        uid: currentUser.uid, 
                        mode: mode, 
                        xId: userData.xId, 
                        displayName: userData.displayName, // å¾…æ©Ÿãƒªã‚¹ãƒˆã«ã‚‚åå‰ã‚’è¡¨ç¤ºã§ãã‚‹ã‚ˆã†ã«
                        rate: userData.rate, 
                        createdAt: new Date()
                    });
                    waitingDocId = ref.id;
                    const roomQ = query(collection(db, "rooms"), where("player1.uid", "==", currentUser.uid));
                    unsubscribeRoom = onSnapshot(roomQ, snap => {
                        snap.docChanges().forEach(c => {
                            if(c.type === "added") {
                                waitingDocId = null; unsubscribeRoom();
                                localStorage.setItem('current_room_id', c.doc.id);
                                watchRoom(c.doc.id);
                            }
                        });
                    });
                }
            } catch(e) { console.error(e); alert("ã‚¨ãƒ©ãƒ¼: "+e.message); switchScreen('title-screen'); }
        };

        const watchRoom = (roomId) => {
            currentRoomId = roomId;
            unsubscribeRoom = onSnapshot(doc(db, "rooms", roomId), (docSnap) => {
                if(!docSnap.exists()) {
                    localStorage.removeItem('current_room_id');
                    alert("éƒ¨å±‹ãŒè§£æ•£ã•ã‚Œã¾ã—ãŸ");
                    location.reload();
                    return;
                }
                const data = docSnap.data();
                const isP1 = data.player1.uid === currentUser.uid;
                const me = isP1 ? data.player1 : data.player2;
                const opponent = isP1 ? data.player2 : data.player1;
                
                currentMatchData = { me, opponent, songs: data.songs, isP1 };

                // ç”»é¢é·ç§»åˆ¤å®š
                if (me.result && opponent.result) {
                    checkAndFinalize(data.player1.result, data.player2.result, isP1);
                } else if (me.result && !opponent.result) {
                    if (!document.getElementById('waiting-result-screen').classList.contains('active')) {
                        switchScreen('waiting-result-screen');
                    }
                } else {
                    const isGaming = document.getElementById('reveal-screen').classList.contains('active') ||
                                     document.getElementById('report-screen').classList.contains('active');
                    if (!isGaming) startReveal(opponent, data.songs);
                }
            });
        };

        const startReveal = async (opponent, songs) => {
            switchScreen('reveal-screen');
            // ç›¸æ‰‹ã®åå‰ã¨IDã‚’è¡¨ç¤º
            document.getElementById('opponent-x-display').innerText = `${opponent.displayName}\n(${opponent.xId})`;
            
            const con = document.getElementById('song-reveal-container');
            con.innerHTML = "";
            for(let i=0; i<songs.length; i++){
                await new Promise(r=>setTimeout(r, 400));
                const d = document.createElement('div');
                d.style.cssText = "background:#fff3e0; border:2px solid #ff9800; padding:10px; margin:5px 0; border-radius:8px; font-weight:bold; opacity:0; transform:translateX(-10px); transition:0.3s;";
                d.innerHTML = `<span style="background:#ff5722; color:white; padding:2px 5px; border-radius:4px; font-size:0.8rem; margin-right:5px;">${i+1}</span> ${songs[i]}`;
                con.appendChild(d);
                setTimeout(()=> { d.style.opacity=1; d.style.transform="translateX(0)"; }, 50);
            }
            document.getElementById('goto-report-btn').style.display = 'inline-block';
        };

        window.goToReportScreen = () => {
            switchScreen('report-screen');
            document.getElementById('rep-opp-name').innerText = currentMatchData.opponent.displayName;
            document.getElementById('rep-song-1').innerText = currentMatchData.songs[0];
        };

        window.confirmResult = (res) => {
            selectedResult = res;
            const map = { 'WIN':'å‹ã¡', 'LOSE':'è² ã‘', 'DRAW':'å¼•åˆ†' };
            document.getElementById('modal-selection').innerText = map[res];
            document.getElementById('confirm-modal').style.display = 'flex';
        };

        window.submitResult = async () => {
            closeModal('confirm-modal');
            switchScreen('waiting-result-screen');
            const field = currentMatchData.isP1 ? "player1.result" : "player2.result";
            await updateDoc(doc(db, "rooms", currentRoomId), { [field]: selectedResult });
        };

        const checkAndFinalize = async (p1Res, p2Res, amIP1) => {
            const myRes = amIP1 ? p1Res : p2Res;
            const oppRes = amIP1 ? p2Res : p1Res;

            let valid = false;
            if ((myRes === 'WIN' && oppRes === 'LOSE') ||
                (myRes === 'LOSE' && oppRes === 'WIN') ||
                (myRes === 'DRAW' && oppRes === 'DRAW')) {
                valid = true;
            }

            if (valid) {
                localStorage.removeItem('current_room_id');
                if(unsubscribeRoom) unsubscribeRoom();
                
                // â˜…ã“ã“ã§ãƒ¬ãƒ¼ãƒˆã‚’è¨ˆç®—ã—ã¦DB(users)ã«ä¿å­˜ã™ã‚‹å‡¦ç†ã‚’è¿½åŠ 
                let newRate = userData.rate;
                let diff = 0;
                if(myRes === 'WIN') diff = 20;
                if(myRes === 'LOSE') diff = -20;
                newRate += diff;

                // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ›´æ–° (è‡ªåˆ†ã®åˆ†ã ã‘æ›´æ–°ã™ã‚Œã°OK)
                await updateDoc(doc(db, "users", currentUser.uid), {
                    rate: newRate
                });
                userData.rate = newRate; // ãƒ­ãƒ¼ã‚«ãƒ«ã‚‚æ›´æ–°

                showFinalResult(myRes, diff, newRate);
            } else {
                document.getElementById('error-modal').style.display = 'flex';
            }
        };

        window.retryReport = () => {
            document.getElementById('error-modal').style.display = 'none';
            switchScreen('report-screen');
        };

        const showFinalResult = (result, diff, currentRate) => {
            switchScreen('final-result-screen');
            const title = document.getElementById('final-title');
            const diffEl = document.getElementById('anim-rate-diff');
            
            if(result === 'WIN') {
                title.innerText = "YOU WIN!"; title.style.color = "#e91e63";
                diffEl.innerText = "+" + diff; diffEl.style.color = "#e91e63";
            } else if(result === 'LOSE') {
                title.innerText = "YOU LOSE..."; title.style.color = "#2196f3";
                diffEl.innerText = diff; diffEl.style.color = "#2196f3";
            } else {
                title.innerText = "DRAW"; title.style.color = "#9c27b0";
                diffEl.innerText = "Â±0"; diffEl.style.color = "#9c27b0";
            }

            document.getElementById('anim-rate-val').innerText = currentRate;
            setTimeout(() => diffEl.classList.add('show'), 500);
        };

        window.returnToTitle = () => {
            localStorage.removeItem('current_room_id');
            location.reload();
        };

        window.cancelMatching = async () => {
            localStorage.removeItem('current_room_id');
            if(waitingDocId) await deleteDoc(doc(db, "waiting_room", waitingDocId));
            switchScreen('title-screen');
        };
    </script>
</body>
</html>
