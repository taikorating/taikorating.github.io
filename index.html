<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>太鼓レーティングマッチ（診断モード）</title>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;900&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: sans-serif; background: #fce4d6; text-align: center; color: #333; padding: 20px; }
        .btn { padding: 15px; width: 100%; margin: 10px 0; background: #333; color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; }
        .btn-red { background: #d32f2f; }
        .log-box { text-align: left; background: #fff; border: 1px solid #ccc; padding: 10px; margin-bottom: 20px; height: 150px; overflow-y: scroll; font-size: 0.8rem; font-family: monospace; }
    </style>
    <script>
        window.onerror = function(msg, url, line, col, error) {
            alert("【エラー発生】\n" + msg + "\n行: " + line);
            document.getElementById('debug-log').innerHTML += `<p style="color:red;">ERROR: ${msg} (Line:${line})</p>`;
        };
        console.log = (function(old_function){
            return function(text){
                old_function(text);
                const box = document.getElementById('debug-log');
                if(box) box.innerHTML += `<p>${text}</p>`;
            };
        }(console.log));
    </script>
</head>
<body>

    <h1>診断・修復モード</h1>
    <p>起動しない原因を特定します。</p>

    <div id="debug-log" class="log-box">ログ待機中...</div>

    <button class="btn btn-red" onclick="emergencyReset()">⚠️ アプリを初期化して修復</button>
    
    <hr>
    
    <p>↓この下に通常画面が表示されます↓</p>
    <div id="app-content"></div>

    <script type="module">
        console.log("1. スクリプト開始");

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        console.log("2. モジュール読み込み完了");

        const firebaseConfig = {
          apiKey: "AIzaSyBU1LAF6ceIsezKarsiecSTbH87Cb3gnTw",
          authDomain: "taikorating.firebaseapp.com",
          projectId: "taikorating",
          storageBucket: "taikorating.firebasestorage.app",
          messagingSenderId: "657970223088",
          appId: "1:657970223088:web:509230d6b20d78cbf3af35",
          measurementId: "G-PJXEXL5E9M"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            console.log("3. Firebase初期化成功");

            onAuthStateChanged(auth, async (user) => {
                console.log("4. 認証状態確認: " + (user ? "ログイン中" : "未ログイン"));
                if (user) {
                    console.log("UID: " + user.uid);
                    try {
                        console.log("5. データベース接続テスト...");
                        const userRef = doc(db, "users", user.uid);
                        const snap = await getDoc(userRef);
                        console.log("6. データ取得成功: " + (snap.exists() ? "あり" : "なし(新規)"));
                        alert("診断OK！\nデータ取得に成功しました。\nこれで「初期化」ボタンを押してから、元のコードに戻してください。");
                    } catch (e) {
                        console.error(e);
                        alert("データベースエラー:\n" + e.message + "\n\nAPIキーの制限設定か、通信環境を確認してください。");
                    }
                } else {
                    alert("未ログイン状態です。\nこの画面ではログインできませんが、Firebaseへの接続は正常です。");
                }
            });

        } catch (e) {
            alert("起動エラー:\n" + e.message);
        }

        // --- 緊急リセット機能 ---
        window.emergencyReset = async () => {
            if(!confirm("ログイン情報と一時データを削除してリセットしますか？\n(レート等のデータは消えません)")) return;
            
            // ローカルストレージ全消去
            localStorage.clear();
            sessionStorage.clear();
            
            // IndexedDB (Firebaseのキャッシュ) を削除
            try {
                const dbs = await window.indexedDB.databases();
                dbs.forEach(db => window.indexedDB.deleteDatabase(db.name));
                console.log("キャッシュ削除完了");
            } catch(e) { console.log("キャッシュ削除スキップ"); }

            alert("リセット完了。\nページを再読み込みします。");
            location.reload();
        };
    </script>
</body>
</html>
