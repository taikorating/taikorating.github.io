<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤ªé¼“ãƒ©ãƒ³ãƒ€ãƒ ãƒãƒƒãƒ</title>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;900&display=swap" rel="stylesheet">
    <style>
        /* --- åŸºæœ¬ãƒªã‚»ãƒƒãƒˆ --- */
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'M PLUS Rounded 1c', "Hiragino Kaku Gothic ProN", sans-serif;
            background-color: #fce4d6;
            background-image: radial-gradient(#ffccbc 10%, transparent 10%);
            background-size: 20px 20px;
            color: #333;
            overflow-y: auto;
            min-height: 100vh;
            user-select: none;
            -webkit-user-select: none;
        }

        /* --- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ --- */
        .game-container {
            background: #fff;
            padding: 20px;
            text-align: center;
            position: relative;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            margin: 0 auto;
            height: auto; 
            z-index: 10;
        }

        .game-container.pc-mode {
            width: 100%;
            max-width: 500px;
            min-height: 800px;
            margin-top: 40px;
            margin-bottom: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            border: 4px solid #ff5722;
        }

        .game-container.mobile-mode {
            width: 100%;
            min-height: 100vh;
            border: none;
            border-radius: 0;
            box-shadow: none;
        }

        /* --- å…±é€šãƒ‘ãƒ¼ãƒ„ --- */
        h1, h2, h3 { font-weight: 900; }
        .title-logo { font-size: 2.2rem; color: #ff5722; text-shadow: 2px 2px 0px #ffe0b2; margin-bottom: 5px; }
        .sub-title { color: #f57c00; font-weight: bold; margin-bottom: 10px; font-size: 0.9rem; }
        
        /* æ³¨æ„æ›¸ããƒœãƒƒã‚¯ã‚¹ */
        .note-box {
            background: #fff3e0;
            border: 1px solid #ffe0b2;
            color: #ef6c00;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            text-align: left;
            margin-bottom: 20px;
            line-height: 1.4;
            user-select: text;
            -webkit-user-select: text;
        }

        button { font-family: inherit; outline: none; }
        .btn { 
            border: none; padding: 12px; border-radius: 10px; 
            cursor: pointer; transition: 0.1s; width: 100%; 
            font-weight: bold; color: white; margin-bottom: 10px; 
            box-shadow: 0 4px 0 rgba(0,0,0,0.1); position: relative; top: 0;
            touch-action: manipulation;
        }
        .btn:active { top: 3px; box-shadow: 0 1px 0 rgba(0,0,0,0.1); }
        .btn-orange { background: #ff5722; }
        .btn-blue { background: #2196f3; }
        .btn-green { background: #4caf50; }
        .btn-teal { background: #009688; }
        .btn-gray { background: #757575; }
        .btn-red { background: #d32f2f; }
        .btn-x-share { background: #000; margin-top: 5px; }
        
        .view-toggle-box { margin-top: 30px; padding-top: 20px; border-top: 1px dashed #ccc; }
        .view-btn { background: transparent; border: 2px solid #aaa; color: #555; padding: 5px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; margin: 0 5px; touch-action: manipulation; }
        .view-btn.active { background: #555; color: white; border-color: #555; }

        .login-btn-group { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .btn-google { background: #db4437; }
        .btn-email { background: #607d8b; }
        
        .profile-bar {
            background: #333; color: white; padding: 15px; border-radius: 12px;
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; box-shadow: 0 4px 0 #000;
            flex-wrap: wrap; /* ãƒ¡ãƒ¼ã‚¿ãƒ¼ã®ãŸã‚ã«æŠ˜ã‚Šè¿”ã—è¨±å¯ */
        }
        .profile-info-left { text-align: left; }
        .profile-name { font-size: 0.9rem; }
        .profile-udemae { font-size: 1.8rem; font-weight: 900; line-height: 1; text-shadow: 1px 1px 0 rgba(0,0,0,0.5); margin-right: 5px;}
        .settings-icon { cursor: pointer; font-size: 1.2rem; margin-left: 10px;}

        /* --- ã‚¦ãƒ‡ãƒã‚¨ãƒ¡ãƒ¼ã‚¿ãƒ¼ --- */
        .meter-container {
            width: 100%;
            margin-top: 8px;
        }
        .meter-bg {
            width: 100%;
            height: 12px;
            background: #555;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.5);
        }
        .meter-fill {
            height: 100%;
            width: 0%; /* JSã§åˆ¶å¾¡ */
            background: linear-gradient(90deg, #ffeb3b, #fbc02d);
            transition: width 1s cubic-bezier(0.22, 1, 0.36, 1);
            box-shadow: 0 0 10px #ffeb3b;
        }
        /* ãƒ¡ãƒ¼ã‚¿ãƒ¼ã®åŒºåˆ‡ã‚Šç·š (ä»»æ„) */
        .meter-line {
            position: absolute; top: 0; bottom: 0; width: 1px; background: rgba(255,255,255,0.3);
        }
        .profile-point-text {
            font-size: 0.8rem; color: #ffeb3b; text-align: right; margin-top: 2px; font-weight: bold;
        }


        .menu-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 20px; }
        .menu-btn { height: 70px; font-size: 0.85rem; display: flex; flex-direction: column; justify-content: center; align-items: center; margin-bottom: 0; }
        .menu-btn span { font-size: 1.2rem; margin-bottom: 3px; }
        
        .rank-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        .rank-table th { background: #ffccbc; padding: 8px; color: #d84315; }
        .rank-table td { border-bottom: 1px solid #eee; padding: 8px; }
        .rank-1 { color: #d4af37; font-weight: bold; font-size: 1.1rem; }
        .rank-2 { color: #a0a0a0; font-weight: bold; }
        .rank-3 { color: #cd7f32; font-weight: bold; }
        
        /* ã‚¦ãƒ‡ãƒã‚¨ã®è‰² */
        .udemae-S { color: #ffd700; text-shadow: 0 0 5px #ff6f00; } /* S, S+ */
        .udemae-A { color: #e91e63; } /* Aå¸¯ */
        .udemae-B { color: #2196f3; } /* Bå¸¯ */
        .udemae-C { color: #4caf50; } /* Cå¸¯ */

        .screen { display: none; width: 100%; flex-direction: column; align-items: center; flex: 1; }
        .screen.active { display: flex; }
        .center-content { justify-content: center; }

        .scrollable-content { width: 100%; overflow-y: auto; flex: 1; margin-bottom: 20px; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal-box { background: white; padding: 25px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.3); animation: popIn 0.3s; }
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        .input-field { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 15px; font-size: 1rem; user-select: text; -webkit-user-select: text;}
        .input-label { display: block; text-align: left; font-weight: bold; margin-bottom: 5px; font-size: 0.8rem; color: #555; }
        .loader { border: 6px solid #f3f3f3; border-top: 6px solid #ff5722; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .song-list-box { text-align: left; margin: 10px 0; padding-left: 20px; font-weight: bold; color: #555; font-size: 0.9rem;}
        .song-list-item { margin-bottom: 5px; }
        
        /* é€£çµ¡ç”¨è¡¨ç¤ºã‚¹ã‚¿ã‚¤ãƒ« */
        .instruction-box { 
            background: #e3f2fd; border: 2px solid #2196f3; padding: 15px; border-radius: 10px; 
            font-size: 0.9rem; color: #0d47a1; margin-bottom: 15px; text-align: left; 
            line-height: 1.6;
            user-select: text; -webkit-user-select: text;
        }
        .role-badge {
            display: inline-block; padding: 5px 10px; border-radius: 5px; color: white; font-weight: bold; margin-bottom: 8px;
        }
        .role-host { background: #e91e63; }
        .role-guest { background: #2196f3; }
        
        .result-step-box {
            margin-top: 15px; font-size: 0.85rem; background: #fff; padding: 10px; border-radius: 8px; color: #333;
        }
        .highlight-text { color: #d32f2f; font-weight: bold; }

        .rule-section { text-align: left; margin-bottom: 15px; font-size: 0.9rem; line-height: 1.5; }
        .rule-title { font-weight: bold; color: #ff5722; border-bottom: 2px solid #ffccbc; display: inline-block; margin-bottom: 5px; }

        /* --- è±ªè¯æ¼”å‡ºç”¨ã‚¹ã‚¿ã‚¤ãƒ« --- */
        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50; display: none; }
        .result-container { margin: 20px 0; padding: 20px; border-radius: 20px; background: rgba(255,255,255,0.9); box-shadow: 0 0 30px rgba(255, 87, 34, 0.2); animation: popIn 0.5s; }
        .result-text-win { font-size: 4rem; font-weight: 900; color: #ffd700; text-shadow: 0 0 10px #ffeb3b, 2px 2px 0px #f57f17; animation: pulse 1s infinite alternate; margin: 0; line-height: 1; }
        .result-text-lose { font-size: 3rem; color: #5c6bc0; text-shadow: 2px 2px 0px #3949ab; animation: shake 0.5s; }
        @keyframes pulse { from { transform: scale(1); } to { transform: scale(1.05); } }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } 100% { transform: translateX(0); } }
        .rate-box { background: #222; color: #fff; padding: 15px 30px; border-radius: 10px; display: inline-block; margin-top: 20px; box-shadow: inset 0 0 10px #000; position: relative; min-width: 200px; }
        .rate-value { font-size: 3.5rem; font-weight: 900; color: #ffd700; line-height: 1; }
        .rate-sub { font-size: 1.2rem; color: #ccc; margin-top: 5px; display: block; }
        .rate-diff { font-size: 1.2rem; position: absolute; top: -15px; right: -10px; background: #ff5722; color: white; padding: 2px 8px; border-radius: 5px; font-weight: bold; opacity: 0; transition: all 0.5s ease 1s; transform: translateY(10px); }
        .rate-diff.show { opacity: 1; transform: translateY(0); }
        .rate-diff.plus { background: #e91e63; }
        .rate-diff.minus { background: #2196f3; }

        /* æ˜‡æ ¼ãƒ»é™æ ¼æ¼”å‡ºç”¨ */
        .rank-change-text { font-size: 1.5rem; font-weight: bold; margin-top: 10px; animation: popIn 0.5s; }
        .rank-up { color: #e91e63; text-shadow: 0 0 5px #fff; }
        .rank-down { color: #2196f3; }

    </style>
</head>
<body>

    <canvas id="confetti-canvas"></canvas>

    <div id="main-container" class="game-container mobile-mode">
        
        <div id="login-screen" class="screen active center-content">
            <h1 class="title-logo">DON-DER MATCH</h1>
            <p class="sub-title">ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦å¯¾æˆ¦ã‚’å§‹ã‚ã‚ˆã†</p>
            
            <div class="note-box">
                <strong>ã€æ¨å¥¨ã€‘</strong><br>
                å¯¾æˆ¦æ™‚ã®ã‚„ã‚Šå–ã‚Šã§é€šçŸ¥ãŒå¢—ãˆã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€<br>é€šçŸ¥æ¬„ã‚’è’ã‚‰ã—ãŸããªã„å ´åˆã¯<strong>ã“ã®ã‚µã‚¤ãƒˆå°‚ç”¨ã®Xã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</strong>ã‚’ç”¨æ„ã™ã‚‹ã“ã¨ã‚’ãŠã™ã™ã‚ã—ã¾ã™ã€‚
            </div>

            <div class="login-btn-group" style="width: 100%;">
                <button id="btn-login-google" class="btn btn-google">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
                <div style="display:flex; gap:5px;">
                    <input type="email" id="email-input" class="input-field" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" style="margin:0;">
                    <input type="password" id="pass-input" class="input-field" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" style="margin:0;">
                </div>
                <div style="display:flex; gap:5px;">
                    <button id="btn-login-email" class="btn btn-email">ç™»éŒ²/ãƒ­ã‚°ã‚¤ãƒ³</button>
                </div>
                <button id="btn-login-anon" class="btn btn-gray">åŒ¿åã§å§‹ã‚ã‚‹</button>
            </div>
            <div class="view-toggle-box">
                <p style="font-size:0.8rem; margin-bottom:10px;">è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ</p>
                <button id="btn-mobile" class="view-btn active" onclick="setViewMode('mobile')">ã‚¹ãƒãƒ›ç‰ˆ</button>
                <button id="btn-pc" class="view-btn" onclick="setViewMode('pc')">PCç‰ˆ</button>
            </div>
        </div>

        <div id="title-screen" class="screen">
            <h1 class="title-logo">DON-DER MATCH</h1>
            
            <div class="profile-bar">
                <div style="width:100%; display:flex; justify-content:space-between; align-items:center;">
                    <div class="profile-info-left">
                        <div class="profile-name" id="display-name">Loading...</div>
                        <div style="font-size:0.8rem; opacity:0.8;" id="display-xid">@æœªè¨­å®š</div>
                    </div>
                    <div style="text-align:right; display:flex; align-items:center;">
                        <div class="profile-udemae" id="display-rank">C-</div>
                        <span class="settings-icon" onclick="openProfileModal()">âš™ï¸</span>
                    </div>
                </div>
                
                <div class="meter-container">
                    <div class="meter-bg">
                        <div class="meter-fill" id="display-meter-bar"></div>
                        <div class="meter-line" style="left:20%"></div>
                        <div class="meter-line" style="left:40%"></div>
                        <div class="meter-line" style="left:60%"></div>
                        <div class="meter-line" style="left:80%"></div>
                    </div>
                    <div class="profile-point-text" id="display-meter-text">30 / 99</div>
                </div>
            </div>

            <div class="menu-grid">
                <button id="btn-rules" class="btn btn-teal menu-btn"><span>ğŸ“–</span>ãƒ«ãƒ¼ãƒ«</button>
                <button class="btn btn-orange menu-btn" onclick="openRanking()"><span>ğŸ†</span>ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>
                <button class="btn btn-blue menu-btn" onclick="alert('å±¥æ­´æ©Ÿèƒ½ã¯ã¾ã å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã›ã‚“')"><span>ğŸ“œ</span>å¯¾æˆ¦å±¥æ­´</button>
            </div>
            <p style="font-weight:bold; margin-bottom:10px;">å¯¾æˆ¦é›£æ˜“åº¦ã‚’é¸æŠ</p>
            <button id="btn-mode-normal" class="btn btn-green">é›£æ˜“åº¦ F ï½ A+</button>
            <button id="btn-mode-hard" class="btn btn-orange">é›£æ˜“åº¦ S ï½ SS</button>
        </div>

        <div id="matching-screen" class="screen center-content">
            <div class="loader"></div>
            <h3>å¯¾æˆ¦ç›¸æ‰‹ã‚’æ¢ã—ã¦ã„ã¾ã™...</h3>
            <p id="match-status" style="color:#ff5722; margin-top:10px; font-weight:bold;"></p>
            <p style="font-size:0.8rem; color:#777; margin-top:5px;">â€»ç´„60ç§’çµŒéã™ã‚‹ã¨è‡ªå‹•ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã™</p>
            <button id="btn-cancel-match" class="btn btn-gray" style="margin-top:30px; width:50%;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>

        <div id="reveal-screen" class="screen" style="padding-top:20px;">
            <h2 style="color:#ff5722;">MATCH START!</h2>
            <p>VS å¯¾æˆ¦ç›¸æ‰‹</p>
            <div style="font-size:1.5rem; font-weight:bold; color:#1da1f2; border:2px solid #1da1f2; padding:10px; border-radius:10px; margin:10px 0;">
                <span id="opponent-x-display"></span>
            </div>
            <div id="song-reveal-container" style="width:100%; margin-top:10px; flex:1;"></div>
            <button id="goto-report-btn" class="btn btn-green" style="display:none; margin-top:20px; margin-bottom:20px;" onclick="goToReportScreen()">çµæœã‚’å ±å‘Šã™ã‚‹</button>
        </div>

        <div id="report-screen" class="screen center-content" style="justify-content: flex-start; padding-top: 20px;">
            <h2>çµæœå ±å‘Š</h2>
            <div class="scrollable-content">
                <div id="instruction-area" class="instruction-box"></div>

                <div style="background:#f5f5f5; padding:15px; border-radius:10px; width:100%; text-align:left;">
                    <p><strong>ç›¸æ‰‹:</strong> <span id="rep-opp-name" style="font-weight:bold;"></span></p>
                    <p><strong>X ID:</strong> <span id="rep-opp-xid" style="color:#1da1f2; font-weight:bold;"></span></p>
                    <hr style="margin:10px 0; border:none; border-top:1px solid #ddd;">
                    <p><strong>â–¼ èª²é¡Œæ›²ãƒªã‚¹ãƒˆ</strong></p>
                    <div id="rep-song-list" class="song-list-box"></div>
                </div>
            </div>

            <p style="font-weight:bold; margin-bottom:10px;">ã‚ãªãŸã®å‹æ•—ã¯ï¼Ÿ</p>
            <div style="display:flex; gap:10px; width:100%; margin-bottom:20px;">
                <button class="btn" style="background:#e91e63;" onclick="confirmResult('WIN')">å‹ã¡</button>
                <button class="btn" style="background:#9c27b0;" onclick="confirmResult('DRAW')">å¼•åˆ†</button>
                <button class="btn" style="background:#2196f3;" onclick="confirmResult('LOSE')">è² ã‘</button>
            </div>
            
            <button class="btn btn-red" style="margin-bottom:20px;" onclick="tryExitRoom()">é€€å‡ºã™ã‚‹ (ç„¡åŠ¹è©¦åˆ)</button>
        </div>

        <div id="waiting-result-screen" class="screen center-content">
            <div class="loader"></div>
            <h3>ç¢ºèªä¸­...</h3>
            <p>ç›¸æ‰‹ã®å…¥åŠ›ã‚’å¾…ã£ã¦ã„ã¾ã™</p>
            <p style="font-size:0.8rem; color:red; margin-top:20px;">â€»13åˆ†ä»¥ä¸Šå¿œç­”ãŒãªã„å ´åˆã€<br>è‡ªå‹•ã§ã‚¨ãƒ©ãƒ¼ã¨ãªã‚Šçµ‚äº†ã—ã¾ã™ã€‚</p>
            <button class="btn btn-red" style="margin-top:30px; width: auto; padding-left: 30px; padding-right: 30px;" onclick="tryExitRoom()">é€€å‡ºã™ã‚‹ (ç„¡åŠ¹è©¦åˆ)</button>
        </div>

        <div id="final-result-screen" class="screen center-content">
            <div class="result-container">
                <h1 id="final-title">WIN!</h1>
                <p id="final-message" style="margin-bottom:15px; font-weight:bold;"></p>
                
                <div class="rate-box">
                    <div class="rate-value" id="anim-rank-val">C-</div>
                    <div class="meter-container" style="margin-top:15px;">
                        <div class="meter-bg">
                            <div class="meter-fill" id="anim-meter-bar"></div>
                            <div class="meter-line" style="left:20%"></div>
                            <div class="meter-line" style="left:40%"></div>
                            <div class="meter-line" style="left:60%"></div>
                            <div class="meter-line" style="left:80%"></div>
                        </div>
                        <div class="profile-point-text" id="anim-point-val">30 / 99</div>
                    </div>
                    <div class="rate-diff" id="anim-point-diff">+10</div>
                </div>

                <div id="rank-change-msg" class="rank-change-text"></div>
            </div>
            <button id="btn-return-title" class="btn btn-gray" style="margin-top:30px;">ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹</button>
        </div>
    </div>

    <div id="rule-modal" class="modal-overlay">
        <div class="modal-box" style="max-width:500px; max-height:80vh; overflow-y:auto; text-align:left;">
            <h3 style="text-align:center; margin-bottom:20px;">éŠã³æ–¹ãƒ»ãƒ«ãƒ¼ãƒ«</h3>
            <div class="rule-section">
                <div class="rule-title">1. ãƒãƒƒãƒãƒ³ã‚°ã¨å½¹å‰²</div>
                <p>ãƒãƒƒãƒãƒ³ã‚°ãŒæˆç«‹ã™ã‚‹ã¨ã€ãƒ©ãƒ³ãƒ€ãƒ ã«<strong>HOSTï¼ˆãƒ›ã‚¹ãƒˆï¼‰</strong>ã¨<strong>GUESTï¼ˆã‚²ã‚¹ãƒˆï¼‰</strong>ã«åˆ†ã‹ã‚Œã¾ã™ã€‚<br>HOST: å¯¾æˆ¦ç•ªå·ã‚’ãƒ„ã‚¤ãƒ¼ãƒˆã™ã‚‹ä¿‚<br>GUEST: ãã®ãƒ„ã‚¤ãƒ¼ãƒˆã‚’æ¤œç´¢ã—ã¦ãƒªãƒ—ã™ã‚‹ä¿‚</p>
            </div>
            <div class="rule-section">
                <div class="rule-title">2. X (Twitter) ã§ã®ã‚„ã‚Šå–ã‚Š</div>
                <p>ãƒ›ã‚¹ãƒˆã®ãƒ„ã‚¤ãƒ¼ãƒˆã«ã€Œã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ï¼ã€ã¨ãƒªãƒ—ãƒ©ã‚¤ã—ã€ãã®ãƒ„ãƒªãƒ¼ã«<strong>ãŠäº’ã„ãŒ1æ›²ãšã¤ãƒªã‚¶ãƒ«ãƒˆç”»åƒã‚’è²¼ã£ã¦ãã ã•ã„ã€‚</strong></p>
            </div>
            <div class="rule-section">
                <div class="rule-title">3. å‹æ•—æ¡ä»¶</div>
                <p>èª²é¡Œæ›²3æ›²ã®<strong>ã€Œè‰¯ã€ã®æ•°ã®åˆè¨ˆ</strong>ãŒå¤šã„æ–¹ãŒå‹åˆ©ã§ã™ã€‚<br>
                (ä¸å¯ã‚„ã‚³ãƒ³ãƒœæ•°ã¯é–¢ä¿‚ã‚ã‚Šã¾ã›ã‚“)<br>
                <span style="color:#e91e63; font-weight:bold;">â€»ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆã°ã„ããã€ã‚ã¹ã“ã¹ç­‰ï¼‰ã¯è‡ªç”±ã§ã™ã€‚</span></p>
            </div>
            <div class="rule-section">
                <div class="rule-title">4. ã‚¦ãƒ‡ãƒã‚¨ã‚·ã‚¹ãƒ†ãƒ </div>
                <p>C-ã‹ã‚‰S+ã¾ã§ã®ãƒ©ãƒ³ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚å‹ã¤ã¨ãƒã‚¤ãƒ³ãƒˆãŒå¢—ãˆã€100ptã‚’è¶…ãˆã‚‹ã¨æ˜‡æ ¼ã€0ptã‚’å‰²ã‚‹ã¨é™æ ¼ã—ã¾ã™ã€‚</p>
            </div>
            <div style="text-align:center; margin-top:20px;">
                <button class="btn btn-gray" onclick="closeModal('rule-modal')">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <div id="profile-modal" class="modal-overlay">
        <div class="modal-box">
            <h3>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š</h3>
            <div style="margin-top:20px;">
                <label class="input-label">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å</label>
                <input type="text" id="edit-name" class="input-field" placeholder="ä¾‹: ã©ã‚“ã¡ã‚ƒã‚“">
                <label class="input-label">X(Twitter) ID</label>
                <p style="font-size:0.7rem; color:#e91e63; text-align:left;">â€»å¯¾æˆ¦ã«ã¯å…ˆé ­ã« @ ãŒå¿…è¦ã§ã™</p>
                <p style="font-size:0.7rem; color:#777; text-align:left;">â€»é€šçŸ¥ãŒå¤šã„ãŸã‚å°‚ç”¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’æ¨å¥¨</p>
                <input type="text" id="edit-xid" class="input-field" placeholder="ä¾‹: @taiko_master">
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-gray" onclick="closeModal('profile-modal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-orange" onclick="saveProfile()">ä¿å­˜</button>
            </div>
            <button class="btn btn-red" style="margin-top:20px;" onclick="confirmLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
    </div>

    <div id="ranking-modal" class="modal-overlay">
        <div class="modal-box" style="max-width:450px;">
            <h3>ã‚¦ãƒ‡ãƒã‚¨ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
            <div style="max-height:300px; overflow-y:auto;">
                <table class="rank-table">
                    <thead><tr><th>é †ä½</th><th>åå‰</th><th>ã‚¦ãƒ‡ãƒã‚¨</th><th>pt</th></tr></thead>
                    <tbody id="ranking-list"></tbody>
                </table>
            </div>
            <button class="btn btn-gray" style="margin-top:20px;" onclick="closeModal('ranking-modal')">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-box">
            <h3>ç¢ºèª</h3>
            <p style="margin:15px 0;">çµæœã¯ã€Œ<span id="modal-selection" style="font-weight:bold; color:#ff5722;"></span>ã€ã§<br>é–“é•ã„ãªã„ã§ã™ã‹ï¼Ÿ</p>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-gray" onclick="closeModal('confirm-modal')">æˆ»ã‚‹</button>
                <button class="btn btn-orange" onclick="submitResult()">æ±ºå®š</button>
            </div>
        </div>
    </div>

    <div id="error-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="color:#d32f2f;">çµæœä¸ä¸€è‡´</h3>
            <p>ç”³å‘ŠãŒé£Ÿã„é•ã£ã¦ã„ã¾ã™ã€‚<br>ã‚‚ã†ä¸€åº¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
            <button class="btn btn-orange" onclick="retryReport()">å†å…¥åŠ›</button>
        </div>
    </div>

    <div id="exit-confirm-modal-1" class="modal-overlay">
        <div class="modal-box">
            <h3 style="color:#d32f2f;">è­¦å‘Š</h3>
            <p>é€€å‡ºã™ã‚‹ã¨ç„¡åŠ¹è©¦åˆã«ãªã‚Šã¾ã™ã€‚<br>æœ¬å½“ã«é€€å‡ºã—ã¾ã™ã‹ï¼Ÿ</p>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn btn-gray" onclick="closeModal('exit-confirm-modal-1')">ã‚„ã‚ã‚‹</button>
                <button class="btn btn-red" onclick="showExitConfirm2()">ã¯ã„</button>
            </div>
        </div>
    </div>
    <div id="exit-confirm-modal-2" class="modal-overlay">
        <div class="modal-box">
            <h3 style="color:#d32f2f;">æœ€çµ‚ç¢ºèª</h3>
            <p>æœ¬å½“ã«é€€å‡ºã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ<br>(ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“)</p>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn btn-gray" onclick="closeModal('exit-confirm-modal-2')">ã‚„ã‚ã‚‹</button>
                <button class="btn btn-red" onclick="forceExitRoom()">é€€å‡ºã™ã‚‹</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, getRedirectResult } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, onSnapshot, deleteDoc, doc, updateDoc, limit, getDoc, setDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
  apiKey: "AIzaSyBU1LAF6ceIsezKarsiecSTbH87Cb3gnTw",
  authDomain: "taikorating.firebaseapp.com",
  projectId: "taikorating",
  storageBucket: "taikorating.firebasestorage.app",
  messagingSenderId: "657970223088",
  appId: "1:657970223088:web:509230d6b20d78cbf3af35",
  measurementId: "G-PJXEXL5E9M"
};


        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let userData = { displayName: "åç„¡ã—", xId: "æœªè¨­å®š", rankIndex: 0, rankPoint: 30, sortScore: 30 }; 
        let waitingDocId = null;
        let currentRoomId = null;
        let unsubscribeRoom = null;
        let currentMatchData = {};
        let selectedResult = null;
        let isFinalizing = false;
        let matchTimer = null;
        let heartbeatTimer = null;
        let wakeLock = null; 

        const RANKS = ["C-", "C", "C+", "B-", "B", "B+", "A-", "A", "A+", "S", "S+"];

        const songDatabase = {
            'normal': ["å¤ç¥­ã‚Š", "ç´…", "ã•ãã‚‰ã‚“ã¼", "å‰å‰å‰ä¸–", "å¤©ä½“è¦³æ¸¬", "åƒæœ¬æ¡œ", "å¥³ã€…ã—ãã¦", "ã‚·ãƒ£ãƒ«ãƒ«"],
            'hard': ["å¹½ç„ãƒä¹±", "ãƒ‰ãƒ³ã‚«ãƒ2000", "ç¬¬å…­å¤©é­”ç‹", "ã‚«ã‚ªã‚¹ã‚¿ã‚¤ãƒ ", "Infinite Rebellion", "åŒç«œãƒä¹±", "poxeiâ™¦DOON"]
        };

        // --- ã‚¦ãƒ‡ãƒã‚¨è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ ---
        const getRankName = (idx) => RANKS[idx] || "C-";
        const getRankColorClass = (idx) => {
            const name = getRankName(idx);
            if(name.startsWith('S')) return 'udemae-S';
            if(name.startsWith('A')) return 'udemae-A';
            if(name.startsWith('B')) return 'udemae-B';
            return 'udemae-C';
        };
        
        // ãƒ©ãƒ³ã‚¯ã”ã¨ã®åŸºç¤ç‚¹è¨­å®š
        const getBasePoint = (rankName) => {
            if (rankName.startsWith('S')) return { win: 5, lose: 5 }; // S, S+
            if (rankName.startsWith('A')) return { win: 12, lose: 10 };
            if (rankName.startsWith('B')) return { win: 15, lose: 10 };
            return { win: 20, lose: 10 }; // Cå¸¯
        };

        const requestWakeLock = async () => {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    wakeLock.addEventListener('release', () => {});
                }
            } catch (err) { console.error(err); }
        };
        document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') await requestWakeLock();
        });

        const handleUnload = () => {
            if (currentRoomId && currentUser) deleteDoc(doc(db, "rooms", currentRoomId)).catch(()=>{});
            if (waitingDocId) deleteDoc(doc(db, "waiting_room", waitingDocId)).catch(()=>{});
        };
        window.addEventListener('beforeunload', handleUnload);

        window.setViewMode = (mode) => {
            const container = document.getElementById('main-container');
            const btnMobile = document.getElementById('btn-mobile');
            const btnPc = document.getElementById('btn-pc');
            if (mode === 'pc') {
                container.classList.remove('mobile-mode'); container.classList.add('pc-mode');
                btnMobile.classList.remove('active'); btnPc.classList.add('active');
                localStorage.setItem('view_mode', 'pc');
            } else {
                container.classList.remove('pc-mode'); container.classList.add('mobile-mode');
                btnMobile.classList.add('active'); btnPc.classList.remove('active');
                localStorage.setItem('view_mode', 'mobile');
            }
        };
        const savedMode = localStorage.getItem('view_mode');
        if (savedMode) window.setViewMode(savedMode);
        else window.setViewMode('mobile');

        const bindBtn = (id, func) => {
            const el = document.getElementById(id);
            if(el) el.addEventListener('click', func);
        };
        bindBtn('btn-login-google', () => {
            const provider = new GoogleAuthProvider();
            provider.setCustomParameters({ prompt: 'select_account' });
            signInWithPopup(auth, provider).catch(e => alert("ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:\n" + e.message));
        });
        bindBtn('btn-login-email', async () => {
            const email = document.getElementById('email-input').value;
            const pass = document.getElementById('pass-input').value;
            if(!email || !pass) return alert("å…¥åŠ›ã—ã¦ãã ã•ã„");
            try { await signInWithEmailAndPassword(auth, email, pass); }
            catch(e) { try { await createUserWithEmailAndPassword(auth, email, pass); } catch(e2) { alert(e2.message); } }
        });
        bindBtn('btn-login-anon', () => signInAnonymously(auth).catch(e => alert(e.message)));

        bindBtn('btn-mode-normal', () => window.tryStartMatching('normal'));
        bindBtn('btn-mode-hard', () => window.tryStartMatching('hard'));
        bindBtn('btn-cancel-match', () => window.cancelMatching());
        bindBtn('btn-return-title', () => window.returnToTitle());
        bindBtn('btn-rules', () => document.getElementById('rule-modal').style.display = 'flex');

        window.confirmLogout = async () => {
            if (confirm("æœ¬å½“ã«ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ")) {
                await signOut(auth);
                location.reload();
            }
        };

        getRedirectResult(auth).catch((error) => {
            console.error("Redirect login error:", error);
            if (error.code !== 'auth/popup-closed-by-user') {
                alert("ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n" + error.message);
            }
        });

        onAuthStateChanged(auth, async (user) => {
            if(user) {
                currentUser = user;
                try {
                    const userRef = doc(db, "users", user.uid);
                    const userSnap = await getDoc(userRef);
                    if (userSnap.exists()) {
                        userData = userSnap.data();
                        if (userData.isBanned) {
                            alert("ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯å‡çµã•ã‚Œã¦ã„ã¾ã™ã€‚");
                            await signOut(auth);
                            location.reload();
                            return;
                        }
                        if(userData.rankIndex === undefined) {
                            userData.rankIndex = 0;
                            userData.rankPoint = 30;
                            userData.sortScore = 30;
                        }
                    } else {
                        userData = { displayName: "åç„¡ã—ã©ã‚“", xId: "æœªè¨­å®š", rankIndex: 0, rankPoint: 30, sortScore: 30, createdAt: new Date() };
                        await setDoc(userRef, userData);
                    }
                    updateProfileUI();
                    switchScreen('title-screen');
                    const savedRoomId = localStorage.getItem('current_room_id');
                    if (savedRoomId) checkRestore(savedRoomId);
                } catch(e) { console.error(e); switchScreen('title-screen'); }
            }
        });

        const updateProfileUI = () => {
            document.getElementById('display-name').innerText = userData.displayName;
            document.getElementById('display-xid').innerText = userData.xId;
            
            const rankName = getRankName(userData.rankIndex);
            const point = userData.rankPoint;
            const el = document.getElementById('display-rank');
            const pointEl = document.getElementById('display-point'); // è¿½åŠ : æ•°å€¤è¡¨ç¤ºç”¨
            const meterBar = document.getElementById('display-meter-bar');
            const meterText = document.getElementById('display-meter-text');
            
            el.innerText = rankName;
            el.className = `profile-udemae ${getRankColorClass(userData.rankIndex)}`;
            
            // ãƒ¡ãƒ¼ã‚¿ãƒ¼æ›´æ–°
            const percentage = Math.min(100, Math.max(0, point));
            meterBar.style.width = `${percentage}%`;
            meterText.innerText = `${point} / 99`;

            document.getElementById('edit-name').value = userData.displayName;
            document.getElementById('edit-xid').value = userData.xId;
        };

        window.openProfileModal = () => document.getElementById('profile-modal').style.display = 'flex';
        window.saveProfile = async () => {
            const newName = document.getElementById('edit-name').value;
            const newXid = document.getElementById('edit-xid').value;
            if(!newName) return alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            await setDoc(doc(db, "users", currentUser.uid), { displayName: newName, xId: newXid || "æœªè¨­å®š" }, { merge: true });
            userData.displayName = newName; userData.xId = newXid || "æœªè¨­å®š";
            updateProfileUI(); closeModal('profile-modal');
        };

        window.openRanking = async () => {
            document.getElementById('ranking-modal').style.display = 'flex';
            const tbody = document.getElementById('ranking-list');
            tbody.innerHTML = '<tr><td colspan="4">èª­ã¿è¾¼ã¿ä¸­...</td></tr>';
            try {
                const q = query(collection(db, "users"), orderBy("sortScore", "desc"), limit(10));
                const snapshot = await getDocs(q);
                tbody.innerHTML = "";
                let rank = 1;
                snapshot.forEach(doc => {
                    const d = doc.data();
                    const tr = document.createElement('tr');
                    const rIdx = d.rankIndex !== undefined ? d.rankIndex : 0;
                    const rPnt = d.rankPoint !== undefined ? d.rankPoint : 0;
                    const rName = getRankName(rIdx);
                    const rColor = getRankColorClass(rIdx);
                    
                    tr.innerHTML = `<td class="rank-${rank}">${rank}</td>
                                    <td style="text-align:left;">${d.displayName || 'åç„¡ã—'}</td>
                                    <td class="${rColor}" style="font-weight:bold;">${rName}</td>
                                    <td>${rPnt}</td>`;
                    tbody.appendChild(tr);
                    rank++;
                });
            } catch(e) { tbody.innerHTML = '<tr><td colspan="4">èª­ã¿è¾¼ã¿å¤±æ•—</td></tr>'; }
        };

        window.tryStartMatching = (mode) => {
            if (userData.xId === "æœªè¨­å®š" || !userData.xId.startsWith("@")) {
                alert("ã€è¨­å®šã‚¨ãƒ©ãƒ¼ã€‘\nX IDã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚");
                openProfileModal(); return;
            }
            startMatching(mode);
        };

        const switchScreen = (id) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        };
        window.closeModal = (id) => document.getElementById(id).style.display = 'none';

        const checkRestore = async (roomId) => {
             try {
                 const roomSnap = await getDoc(doc(db, "rooms", roomId));
                 if(roomSnap.exists()) {
                     requestWakeLock();
                     startHeartbeat(roomId);
                     watchRoom(roomId);
                 } else {
                     localStorage.removeItem('current_room_id');
                 }
             } catch(e) { localStorage.removeItem('current_room_id'); }
        };

        const pickRandomSongs = (mode) => {
            const list = songDatabase[mode] || [];
            return [...list].sort(() => 0.5 - Math.random()).slice(0, 3);
        };

        const startMatching = async (mode) => {
            switchScreen('matching-screen');
            document.getElementById('match-status').innerText = "å¯¾æˆ¦ç›¸æ‰‹ã‚’å¾…ã£ã¦ã„ã¾ã™...";
            try {
                const q = query(collection(db, "waiting_room"), where("mode", "==", mode), limit(20));
                const snap = await getDocs(q);
                let opponentDoc = null;
                const now = Date.now();

                for (const d of snap.docs) {
                    const data = d.data();
                    const elapsed = data.createdAt ? (now - data.createdAt.toMillis()) : 99999;
                    if (elapsed > 60000) { deleteDoc(doc(db, "waiting_room", d.id)).catch(()=>{}); continue; }
                    if (elapsed > 55000) { continue; }
                    if(data.uid !== currentUser.uid) { opponentDoc = d; break; }
                }

                if(opponentDoc) {
                    const opp = opponentDoc.data();
                    const matchId = Math.floor(10000000 + Math.random() * 90000000).toString();
                    const roomRef = await addDoc(collection(db, "rooms"), {
                        mode: mode, songs: pickRandomSongs(mode), createdAt: new Date(),
                        matchId: matchId,
                        player1: { uid: opp.uid, xId: opp.xId, displayName: opp.displayName, rankIndex: opp.rankIndex, rankPoint: opp.rankPoint, result: null, lastSeen: Date.now() },
                        player2: { uid: currentUser.uid, xId: userData.xId, displayName: userData.displayName, rankIndex: userData.rankIndex, rankPoint: userData.rankPoint, result: null, lastSeen: Date.now() }
                    });
                    await deleteDoc(doc(db, "waiting_room", opponentDoc.id));
                    localStorage.setItem('current_room_id', roomRef.id);
                    requestWakeLock();
                    startHeartbeat(roomRef.id);
                    watchRoom(roomRef.id);
                } else {
                    const ref = await addDoc(collection(db, "waiting_room"), {
                        uid: currentUser.uid, mode: mode, xId: userData.xId, displayName: userData.displayName, 
                        rankIndex: userData.rankIndex, rankPoint: userData.rankPoint, createdAt: new Date()
                    });
                    waitingDocId = ref.id;
                    
                    if(matchTimer) clearTimeout(matchTimer);
                    matchTimer = setTimeout(async () => {
                        if(waitingDocId) {
                            if(unsubscribeRoom) unsubscribeRoom();
                            unsubscribeRoom = null;
                            const me1 = await getDocs(query(collection(db, "rooms"), where("player1.uid", "==", currentUser.uid)));
                            if(!me1.empty) {
                                const roomDoc = me1.docs[0];
                                waitingDocId = null; 
                                localStorage.setItem('current_room_id', roomDoc.id);
                                requestWakeLock();
                                startHeartbeat(roomDoc.id);
                                watchRoom(roomDoc.id);
                                return;
                            }
                            try { await deleteDoc(doc(db, "waiting_room", waitingDocId)); } catch(e){}
                            waitingDocId = null;
                            switchScreen('title-screen');
                            alert("ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã€‘\nä¸€å®šæ™‚é–“ãƒãƒƒãƒãƒ³ã‚°ã—ãªã‹ã£ãŸãŸã‚ã€\nè‡ªå‹•ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚");
                        }
                    }, 60000);

                    const roomQ = query(collection(db, "rooms"), where("player1.uid", "==", currentUser.uid));
                    unsubscribeRoom = onSnapshot(roomQ, snap => {
                        snap.docChanges().forEach(c => {
                            if(c.type === "added") {
                                if(matchTimer) clearTimeout(matchTimer); 
                                waitingDocId = null; unsubscribeRoom();
                                localStorage.setItem('current_room_id', c.doc.id);
                                requestWakeLock();
                                startHeartbeat(c.doc.id);
                                watchRoom(c.doc.id);
                            }
                        });
                    });
                }
            } catch(e) { console.error(e); alert("ãƒãƒƒãƒãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:\n" + e.message); switchScreen('title-screen'); }
        };

        const startHeartbeat = (roomId) => {
            if(heartbeatTimer) clearInterval(heartbeatTimer);
            updateLastSeen(roomId);
            heartbeatTimer = setInterval(() => {
                if(!currentRoomId) return;
                updateLastSeen(roomId);
            }, 5000); 
        };

        const updateLastSeen = async (roomId) => {
            if(currentMatchData.isP1 !== undefined) {
                const field = currentMatchData.isP1 ? "player1.lastSeen" : "player2.lastSeen";
                try { await updateDoc(doc(db, "rooms", roomId), { [field]: Date.now() }); } catch(e) {}
            }
        }

        const watchRoom = (roomId) => {
            currentRoomId = roomId;
            isFinalizing = false;
            unsubscribeRoom = onSnapshot(doc(db, "rooms", roomId), (docSnap) => {
                if(!docSnap.exists()) {
                    handleForceExit("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n(ç›¸æ‰‹ã®é€šä¿¡åˆ‡æ–­ã€ã¾ãŸã¯é€€å‡º)");
                    return;
                }
                const data = docSnap.data();
                const isP1 = data.player1.uid === currentUser.uid;
                const me = isP1 ? data.player1 : data.player2;
                const opponent = isP1 ? data.player2 : data.player1;
                
                currentMatchData = { me, opponent, songs: data.songs, isP1, createdAt: data.createdAt, matchId: data.matchId };

                const now = Date.now();
                if (opponent.lastSeen && (now - opponent.lastSeen > 780000)) { 
                    deleteDoc(doc(db, "rooms", roomId)).catch(()=>{});
                    return; 
                }

                if (me.result && opponent.result) {
                    if (!isFinalizing) {
                        isFinalizing = true;
                        checkAndFinalize(data.player1.result, data.player2.result, isP1);
                    }
                } else if (me.result && !opponent.result) {
                    if (!document.getElementById('waiting-result-screen').classList.contains('active')) {
                        switchScreen('waiting-result-screen');
                    }
                } else {
                    const isGaming = document.getElementById('reveal-screen').classList.contains('active') ||
                                     document.getElementById('report-screen').classList.contains('active');
                    if (document.getElementById('waiting-result-screen').classList.contains('active')) {
                        goToReportScreen();
                    } else if (!isGaming) {
                        startReveal(opponent, data.songs);
                    }
                }
            });
        };

        const handleForceExit = (msg) => {
            if(heartbeatTimer) clearInterval(heartbeatTimer);
            if(wakeLock) wakeLock.release().then(()=> wakeLock = null).catch(()=>{});
            localStorage.removeItem('current_room_id');
            alert(msg);
            location.reload();
        };

        const startReveal = async (opponent, songs) => {
            switchScreen('reveal-screen');
            document.getElementById('opponent-x-display').innerText = `${opponent.displayName}\n(${opponent.xId})`;
            const con = document.getElementById('song-reveal-container');
            con.innerHTML = "";
            for(let i=0; i<songs.length; i++){
                await new Promise(r=>setTimeout(r, 400));
                const d = document.createElement('div');
                d.style.cssText = "background:#fff3e0; border:2px solid #ff9800; padding:10px; margin:5px 0; border-radius:8px; font-weight:bold; opacity:0; transform:translateX(-10px); transition:0.3s;";
                d.innerHTML = `<span style="background:#ff5722; color:white; padding:2px 5px; border-radius:4px; font-size:0.8rem; margin-right:5px;">${i+1}</span> ${songs[i]}`;
                con.appendChild(d);
                setTimeout(()=> { d.style.opacity=1; d.style.transform="translateX(0)"; }, 50);
            }
            document.getElementById('goto-report-btn').style.display = 'inline-block';
        };

        window.goToReportScreen = () => {
            switchScreen('report-screen');
            document.getElementById('rep-opp-name').innerText = currentMatchData.opponent.displayName;
            document.getElementById('rep-opp-xid').innerText = currentMatchData.opponent.xId;
            
            const isHost = currentMatchData.isP1;
            const matchId = currentMatchData.matchId || "--------";
            const instructionArea = document.getElementById('instruction-area');
            
            if (isHost) {
                const tweetText = `@1 å¯¾æˆ¦ç•ªå·${matchId}`;
                const url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(tweetText)}`;
                instructionArea.innerHTML = `
                    <span class="role-badge role-host">HOST (å‹Ÿé›†)</span>
                    <p><strong>1åˆ†ä»¥å†…</strong>ã«ä»¥ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰ãƒ„ã‚¤ãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚</p>
                    <div style="margin:10px 0; font-weight:bold; color:#333; background:#fff; padding:5px; border-radius:4px;">
                        @1 å¯¾æˆ¦ç•ªå·${matchId}
                    </div>
                    <a href="${url}" target="_blank" class="btn btn-x-share" style="display:block; text-decoration:none; text-align:center; color:white; margin-top:10px;">ãƒ„ã‚¤ãƒ¼ãƒˆã™ã‚‹</a>
                    <div class="result-step-box">
                        <strong>ã€ãƒªã‚¶ãƒ«ãƒˆæå‡ºã€‘</strong><br>
                        ç›¸æ‰‹ã‹ã‚‰ã€Œã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ï¼ã€ã¨ãƒªãƒ—ãŒæ¥ãŸã‚‰ã€<br>
                        <span class="highlight-text">ãã®ãƒªãƒ—ãƒ©ã‚¤ã«å¯¾ã—ã¦</span>1æ›²ãšã¤ãƒªã‚¶ãƒ«ãƒˆã‚’è²¼ã£ã¦ãã ã•ã„ã€‚<br>
                        (è¨ˆ6æšã®ãƒªãƒ—ãŒã¶ã‚‰ä¸‹ãŒã‚‹å½¢ã«ãªã‚Šã¾ã™)
                    </div>
                    <p style="font-size:0.8rem; color:#d32f2f; margin-top:10px;">
                        â€»1ã€œ2åˆ†å¾…ã£ã¦ã‚‚è¿”ä¿¡ãŒæ¥ãªã„å ´åˆã¯ã€<br>ä¸€ç•ªä¸‹ã®ã€Œé€€å‡ºã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚
                    </p>
                    <p style="margin-top:15px; font-weight:bold; border-bottom:2px solid #e91e63; display:inline-block;">
                        å‹æ•—ï¼š3æ›²åˆè¨ˆã®ã€Œè‰¯ã€ã®æ•°ãŒå¤šã„æ–¹ãŒå‹ã¡ <span style="font-size:0.85rem; font-weight:normal;">(ã‚ªãƒ—ã‚·ãƒ§ãƒ³è‡ªç”±)</span>
                    </p>
                `;
            } else {
                const cleanId = currentMatchData.opponent.xId ? currentMatchData.opponent.xId.replace('@', '') : '';
                const profileUrl = `https://twitter.com/${cleanId}`;
                const searchText = `@1 å¯¾æˆ¦ç•ªå·${matchId}`;
                const searchUrl = `https://twitter.com/search?q=${encodeURIComponent(searchText)}&f=live`;

                instructionArea.innerHTML = `
                    <span class="role-badge role-guest">GUEST (å‚åŠ )</span>
                    <div style="background:white; padding:5px; border-radius:5px; margin:5px 0; font-weight:bold; color:#333;">
                        å¯¾æˆ¦ç•ªå·ï¼š<span style="font-size:1.3rem; color:#e91e63;">${matchId}</span>
                    </div>
                    <p>ç›¸æ‰‹ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã«é£›ã³ã€ä¸Šè¨˜ç•ªå·ã®ãƒ„ã‚¤ãƒ¼ãƒˆã‚’æ¢ã—ã¦ãã ã•ã„ã€‚</p>
                    <p style="color:#d32f2f; font-weight:bold; background:#fff; padding:5px; border-radius:4px; margin:10px 0;">
                        âš ï¸å¿…ãšã€Œè¿”ä¿¡ã€æ¬„ã‚’è¦‹ã¦ãã ã•ã„ï¼<br>
                        <span style="font-size:0.8rem; font-weight:normal;">(@1 ãƒ„ã‚¤ãƒ¼ãƒˆã¯é€šå¸¸ã®ãƒã‚¹ãƒˆæ¬„ã«ã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“)</span>
                    </p>
                    <a href="${profileUrl}" target="_blank" class="btn btn-x-share" style="display:block; text-decoration:none; text-align:center; color:white;">ç›¸æ‰‹ã®Xãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã¸</a>
                    <div style="margin-top:15px; padding:10px; background:#fff3e0; border-radius:8px; font-size:0.85rem;">
                        <strong>ã©ã†ã—ã¦ã‚‚è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ</strong><br>
                        ä»¥ä¸‹ã®æ–‡è¨€ã§æ¤œç´¢ã—ã¦ã¿ã¦ãã ã•ã„ã€‚<br>
                        <div style="font-weight:bold; margin:5px 0; user-select:all; -webkit-user-select:all;">${searchText}</div>
                        <a href="${searchUrl}" target="_blank" style="color:#e65100; text-decoration:underline;">ã“ã“ã‚’æŠ¼ã—ã¦æ¤œç´¢ã™ã‚‹</a>
                    </div>
                    <div class="result-step-box">
                        <strong>ã€ãƒªã‚¶ãƒ«ãƒˆæå‡ºã€‘</strong><br>
                        ç›¸æ‰‹ã®ãƒ„ã‚¤ãƒ¼ãƒˆã«ã€Œã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ï¼ã€ã¨ãƒªãƒ—ã—ãŸå¾Œã€<br>
                        <span class="highlight-text">ãã®è‡ªåˆ†ã®ãƒªãƒ—ãƒ©ã‚¤ã«å¯¾ã—ã¦</span>1æ›²ãšã¤ãƒªã‚¶ãƒ«ãƒˆã‚’è²¼ã£ã¦ãã ã•ã„ã€‚<br>
                        (è¨ˆ6æšã®ãƒªãƒ—ãŒã¶ã‚‰ä¸‹ãŒã‚‹å½¢ã«ãªã‚Šã¾ã™)
                    </div>
                    <div style="margin-top:15px; font-size:0.85rem; color:#555; line-height:1.4;">
                        ç›¸æ‰‹ã¯2åˆ†ä»¥å†…ã«ãƒ„ã‚¤ãƒ¼ãƒˆã™ã‚‹ãƒ«ãƒ¼ãƒ«ã§ã™ã€‚<br>
                        ã¾ãšã¯<strong>1åˆ†ã»ã©å¾…ã£ã¦ã¿ã¦ãã ã•ã„ï¼</strong>
                    </div>
                    <p style="font-size:0.8rem; color:#d32f2f; margin-top:5px;">
                        â€»ã‚‚ã—2åˆ†çµŒã£ã¦ã‚‚ãƒ„ã‚¤ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã€<br>ä¸€ç•ªä¸‹ã®ã€Œé€€å‡ºã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚
                    </p>
                    <p style="margin-top:15px; font-weight:bold; border-bottom:2px solid #2196f3; display:inline-block;">
                        å‹æ•—ï¼š3æ›²åˆè¨ˆã®ã€Œè‰¯ã€ã®æ•°ãŒå¤šã„æ–¹ãŒå‹ã¡ <span style="font-size:0.85rem; font-weight:normal;">(ã‚ªãƒ—ã‚·ãƒ§ãƒ³è‡ªç”±)</span>
                    </p>
                `;
            }

            const listContainer = document.getElementById('rep-song-list');
            listContainer.innerHTML = "";
            currentMatchData.songs.forEach((song, i) => {
                const item = document.createElement('div');
                item.className = "song-list-item";
                item.innerText = `${i+1}. ${song}`;
                listContainer.appendChild(item);
            });
        };

        window.confirmResult = (res) => {
            const now = Date.now();
            const startTime = currentMatchData.createdAt ? currentMatchData.createdAt.toMillis() : now;
            const elapsed = now - startTime;
            if (elapsed < 300000) { 
                alert("ç•°å¸¸ã‚’æ¤œçŸ¥ã—ã¾ã—ãŸã€‚\n3æ›²ã¨ã‚‚æ¼”å¥ã—ã¦ã‹ã‚‰çµæœç”³å‘Šã—ã¦ãã ã•ã„");
                return;
            }
            selectedResult = res;
            const map = { 'WIN':'å‹ã¡', 'LOSE':'è² ã‘', 'DRAW':'å¼•åˆ†' };
            document.getElementById('modal-selection').innerText = map[res];
            document.getElementById('confirm-modal').style.display = 'flex';
        };

        window.submitResult = async () => {
            closeModal('confirm-modal');
            switchScreen('waiting-result-screen');
            const field = currentMatchData.isP1 ? "player1.result" : "player2.result";
            isFinalizing = false; 
            try {
                await updateDoc(doc(db, "rooms", currentRoomId), { [field]: selectedResult });
            } catch(e) { console.error(e); switchScreen('report-screen'); }
        };

        // â˜…â˜…â˜… ã‚¦ãƒ‡ãƒã‚¨è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£… â˜…â˜…â˜…
        const checkAndFinalize = async (p1Res, p2Res, amIP1) => {
            const myRes = amIP1 ? p1Res : p2Res;
            const oppRes = amIP1 ? p2Res : p1Res;
            let valid = false;
            if ((myRes === 'WIN' && oppRes === 'LOSE') ||
                (myRes === 'LOSE' && oppRes === 'WIN') ||
                (myRes === 'DRAW' && oppRes === 'DRAW')) {
                valid = true;
            }

            if (valid) {
                if(unsubscribeRoom) unsubscribeRoom();
                if(heartbeatTimer) clearInterval(heartbeatTimer);
                if(wakeLock) wakeLock.release().catch(()=>{});
                
                // ç¾åœ¨ã®ãƒ©ãƒ³ã‚¯ã¨ãƒã‚¤ãƒ³ãƒˆå–å¾—
                let currentIdx = userData.rankIndex !== undefined ? userData.rankIndex : 0;
                let currentPt = userData.rankPoint !== undefined ? userData.rankPoint : 30;
                const currentRankName = getRankName(currentIdx);

                let gain = 0;
                let isRankUp = false;
                let isRankDown = false;
                
                // åŸºç¤ç‚¹å–å¾—
                const base = getBasePoint(currentRankName);
                
                // ãƒ©ãƒ³ãƒ€ãƒ å¤‰å‹• (-1, 0, +1 ã®æºã‚‰ã)
                const fluctuation = Math.floor(Math.random() * 3) - 1;

                if (myRes === 'WIN') {
                    gain = base.win + fluctuation;
                    currentPt += gain;
                    // æ˜‡æ ¼åˆ¤å®š
                    if (currentPt > 99) {
                        if (currentIdx < RANKS.length - 1) {
                            currentIdx++; 
                            currentPt = 30; 
                            isRankUp = true;
                        } else {
                            currentPt = 99; // ã‚«ãƒ³ã‚¹ãƒˆ
                        }
                    }
                } else if (myRes === 'LOSE') {
                    gain = -(base.lose + fluctuation); // è² ã‘ã¯ãƒã‚¤ãƒŠã‚¹
                    currentPt += gain; // gainãŒãƒã‚¤ãƒŠã‚¹ãªã®ã§è¶³ã™
                    // é™æ ¼åˆ¤å®š
                    if (currentPt < 0) {
                        if (currentIdx > 0) {
                            currentIdx--; 
                            currentPt = 70; 
                            isRankDown = true;
                        } else {
                            currentPt = 0; // C-ä¸‹é™
                        }
                    }
                } else {
                    gain = 0;
                }

                const sortScore = (currentIdx * 100) + currentPt;

                try {
                    await setDoc(doc(db, "users", currentUser.uid), { 
                        rankIndex: currentIdx,
                        rankPoint: currentPt,
                        sortScore: sortScore
                    }, { merge: true });
                    userData.rankIndex = currentIdx;
                    userData.rankPoint = currentPt;
                } catch (e) {}

                showFinalResult(myRes, gain, isRankUp, isRankDown);

            } else {
                isFinalizing = false;
                document.getElementById('error-modal').style.display = 'flex';
            }
        };

        window.retryReport = async () => {
            document.getElementById('error-modal').style.display = 'none';
            const field = currentMatchData.isP1 ? "player1.result" : "player2.result";
            try { await updateDoc(doc(db, "rooms", currentRoomId), { [field]: null }); } catch(e){}
            goToReportScreen();
        };

        const triggerConfetti = () => {
            const canvas = document.getElementById('confetti-canvas');
            const ctx = canvas.getContext('2d');
            canvas.style.display = 'block';
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            const pieces = [];
            for(let i=0; i<150; i++) {
                pieces.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height - canvas.height,
                    color: `hsl(${Math.random() * 360}, 100%, 50%)`,
                    size: Math.random() * 10 + 5,
                    speed: Math.random() * 5 + 2,
                    angle: Math.random() * 360
                });
            }

            function draw() {
                ctx.clearRect(0,0, canvas.width, canvas.height);
                pieces.forEach(p => {
                    ctx.fillStyle = p.color;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.size/2, 0, Math.PI*2);
                    ctx.fill();
                    p.y += p.speed;
                    p.x += Math.sin(p.angle * Math.PI / 180) * 2;
                    if(p.y > canvas.height) p.y = -20;
                });
                requestAnimationFrame(draw);
            }
            draw();
            setTimeout(() => { canvas.style.display = 'none'; }, 5000); 
        };

        const showFinalResult = (result, gain, isUp, isDown) => {
            switchScreen('final-result-screen');
            const title = document.getElementById('final-title');
            const msg = document.getElementById('final-message');
            const diffEl = document.getElementById('anim-point-diff');
            const rankMsg = document.getElementById('rank-change-msg');
            
            diffEl.className = "rate-diff"; 
            rankMsg.innerHTML = ""; 

            if(result === 'WIN') {
                title.innerText = "WIN!"; title.className = "result-text-win";
                msg.innerText = "ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼";
                diffEl.innerText = "+" + gain; diffEl.classList.add("plus");
                if(isUp) {
                    rankMsg.innerHTML = "ãƒ©ãƒ³ã‚¯ã‚¢ãƒƒãƒ—ï¼";
                    rankMsg.className = "rank-change-text rank-up";
                }
                triggerConfetti(); 
            } else if(result === 'LOSE') {
                title.innerText = "LOSE..."; title.className = "result-text-lose";
                msg.innerText = "ãƒ‰ãƒ³ãƒã‚¤ï¼æ¬¡ã“ãã¯ï¼";
                diffEl.innerText = gain; diffEl.classList.add("minus");
                if(isDown) {
                    rankMsg.innerHTML = "ãƒ©ãƒ³ã‚¯ãƒ€ã‚¦ãƒ³...";
                    rankMsg.className = "rank-change-text rank-down";
                }
            } else {
                title.innerText = "DRAW"; title.className = ""; title.style.color = "#9c27b0";
                msg.innerText = "ç†±ã„æˆ¦ã„ã§ã—ãŸï¼";
                diffEl.innerText = "Â±0"; diffEl.style.background = "#9c27b0";
            }

            const rateValEl = document.getElementById('anim-rank-val');
            const rateSubEl = document.getElementById('anim-point-val');
            const meterBar = document.getElementById('anim-meter-bar'); // çµæœç”»é¢ç”¨ãƒ¡ãƒ¼ã‚¿ãƒ¼

            rateValEl.innerText = getRankName(userData.rankIndex);
            rateValEl.className = `rate-value ${getRankColorClass(userData.rankIndex)}`;
            rateSubEl.innerText = `${userData.rankPoint} / 99`;
            
            // ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            setTimeout(() => {
                const percentage = Math.min(100, Math.max(0, userData.rankPoint));
                meterBar.style.width = `${percentage}%`;
                diffEl.classList.add('show'); 
            }, 500);
        };

        window.tryExitRoom = () => {
            document.getElementById('exit-confirm-modal-1').style.display = 'flex';
        };
        window.showExitConfirm2 = () => {
            document.getElementById('exit-confirm-modal-1').style.display = 'none';
            document.getElementById('exit-confirm-modal-2').style.display = 'flex';
        };
        window.forceExitRoom = async () => {
            if (currentRoomId) {
                try { await deleteDoc(doc(db, "rooms", currentRoomId)); } catch(e){}
            }
            if(heartbeatTimer) clearInterval(heartbeatTimer);
            if(wakeLock) wakeLock.release().catch(()=>{});
            localStorage.removeItem('current_room_id');
            location.reload();
        };

        window.returnToTitle = async () => {
            if (currentRoomId) {
                try { await deleteDoc(doc(db, "rooms", currentRoomId)); } catch(e){}
            }
            if(heartbeatTimer) clearInterval(heartbeatTimer);
            if(wakeLock) wakeLock.release().catch(()=>{});
            localStorage.removeItem('current_room_id');
            location.reload();
        };

        window.cancelMatching = async () => {
            if(matchTimer) clearTimeout(matchTimer); 
            localStorage.removeItem('current_room_id');
            if(waitingDocId) await deleteDoc(doc(db, "waiting_room", waitingDocId));
            switchScreen('title-screen');
        };
    </script>
</body>
</html>
